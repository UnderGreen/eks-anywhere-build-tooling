From f223db4d6a984909f30705f6c8f08ca036cbe106 Mon Sep 17 00:00:00 2001
From: Prow Bot <prow@amazonaws.com>
Date: Fri, 9 Jun 2023 15:47:38 +0000
Subject: [PATCH] Install awscli v2 client on RHEL

---
 .../ansible/roles/providers/tasks/aws.yml     |  5 +++-
 .../roles/providers/tasks/awscliv2.yml        | 23 +++++++++++++++++++
 2 files changed, 27 insertions(+), 1 deletion(-)
 create mode 100644 images/capi/ansible/roles/providers/tasks/awscliv2.yml

diff --git a/images/capi/ansible/roles/providers/tasks/aws.yml b/images/capi/ansible/roles/providers/tasks/aws.yml
index 1e5592180..e0c80b907 100644
--- a/images/capi/ansible/roles/providers/tasks/aws.yml
+++ b/images/capi/ansible/roles/providers/tasks/aws.yml
@@ -19,7 +19,10 @@
   vars:
     packages:
       - awscli
-  when: ansible_distribution != "Amazon"
+  when: ansible_distribution != "Amazon" and ansible_distribution != "RedHat"
+
+- include_tasks: awscliv2.yml
+  when: ansible_distribution == "RedHat"
 
 - name: install aws agents RPM
   package:
diff --git a/images/capi/ansible/roles/providers/tasks/awscliv2.yml b/images/capi/ansible/roles/providers/tasks/awscliv2.yml
new file mode 100644
index 000000000..be9b95c9c
--- /dev/null
+++ b/images/capi/ansible/roles/providers/tasks/awscliv2.yml
@@ -0,0 +1,23 @@
+- name: Install AWS CLI
+  yum:
+    name: unzip
+    state: present
+
+- name: Download AWS CLI v2
+  get_url:
+    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
+    dest: /tmp/awscliv2.zip
+
+- name: Unzip AWS CLI v2
+  unarchive:
+    src: /tmp/awscliv2.zip
+    dest: /tmp
+    remote_src: yes
+
+- name: Install AWS CLI v2
+  command: /tmp/aws/install -i /usr/local/aws-cli -b /usr/local/sbin
+
+- name: Remove temporary files
+  file:
+    path: /tmp/aws*
+    state: absent
-- 
2.25.1

